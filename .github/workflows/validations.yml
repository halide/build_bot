name: Buildbot Validations
on:
  push:
  workflow_dispatch:
jobs:
  checkconfig:
    name: Check buildbot config on Python ${{ matrix.python-version }}
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version: [ "3.10", "3.x" ]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - uses: astral-sh/setup-uv@v6

      - name: Check config
        run: |
          openssl rand -hex 20 > secrets/buildbot_www_pass.txt
          openssl rand -hex 20 > secrets/db_password.txt
          echo "$GITHUB_TOKEN" > secrets/github_token.txt
          openssl rand -hex 20 > secrets/halide_bb_pass.txt
          openssl rand -hex 20 > secrets/webhook_token.txt
          uv run --package master buildbot checkconfig master

  worker-deps:
    name: Check worker dependencies install on ${{ matrix.runner }}
    runs-on: ${{ matrix.runner }}

    strategy:
      matrix:
        runner:
          - macos-latest
          - macos-15-intel
          - ubuntu-22.04-arm
          - ubuntu-latest
          - windows-latest

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
      - uses: astral-sh/setup-uv@v6
      - run: uv sync --package worker

  ruff:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check linter rules
        uses: astral-sh/ruff-action@v3

      - name: Check formatting is correct
        uses: astral-sh/ruff-action@v3
        with:
          args: "format --check"

  ty:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v6

      - name: Type-check master config
        run: |
          uv sync
          uv run --package master ty check --error-on-warning master/master.cfg master/custom_steps.py

  bandit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run bandit
        run: pipx run bandit -c pyproject.toml -r master/master.cfg master/custom_steps.py master/buildbot.tac worker/buildbot.tac

  codespell:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run codespell
        run: pipx run codespell

  vulture:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run vulture
        run: pipx run vulture master/master.cfg master/custom_steps.py master/buildbot.tac worker/buildbot.tac

  deploy:
    name: Deploy to buildbot.halide-lang.org
    needs: [ checkconfig, worker-deps, ruff, ty, bandit, codespell, vulture ]
    runs-on: ubuntu-latest
    if: github.repository == 'halide/build_bot' && github.ref == 'refs/heads/master'
    concurrency:
      group: deploy
      cancel-in-progress: false

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: buildbot.halide-lang.org
          port: ${{ secrets.DEPLOY_SSH_PORT }}
          username: ${{ secrets.DEPLOY_SSH_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            cd ~/build_bot
            BEFORE=$(git rev-parse HEAD)
            git pull
            AFTER=$(git rev-parse HEAD)
            BUILD_FLAG=""
            if git diff --name-only "$BEFORE" "$AFTER" | grep -qE '^(master/|master\.sh|pyproject\.toml|uv\.lock)'; then
              BUILD_FLAG="--build"
            fi
            docker compose up -d $BUILD_FLAG
